# Webを支える技術

## Webの要素

![web-element.png](./img/web-element.png)

- UI
    - **人間向けのインターフェイス**
    - ハイパーメディア: テキスト、画像等のコンテンツをハイパーリンクで接続したシステム
        - ユーザーがリンクを自分で選択できる（非線形的情報取得）
        - `Memex, Xanadu, HyperCard: 相互リンク（複雑）` <=> `Web: 単方向リンク（単純）`
            - *Webが普及したのは、そのシンプルさが要因*
- API
    - **プログラム向けのインターフェイス**
    - 分散システム: 複数のコンピュータで処理を分散することで効率的なプログラム実行を実現（<=> 集中システム）
        - RPC(分散関数) < CORBA, DCOM(分散オブジェクト) < REST(分散リソース)
        - `SOUP/WS-*: 関数、メソッド単位の呼び出し（粒度小）` <=> `REST: リソースの状態を呼び出し（粒度大）`
            - 情報の粒度が小さいと呼び出し回数が増えるためオーバーヘッド増大
            - *Webが成功したのは、オーバーヘッドの小ささが要因*

***

## REST

- **Representational State Transfer**
    - HTTPが転送しているのは、単なるHyperTextだけでなく「リソース状態の表現」であるという主張

### RESTの基幹思想
- **接続性**
    - リソースをリンクで接続することで1つのアプリケーションを構成
- ハイパーメディアとしてのREST
    - メディアリソースへURIを通じてアクセス
- 分散システムとしてのREST
    - URIを通じてアプリケーションリソース呼び出し

### RESTfulな設計
- アドレス指定可能なURIで公開されていること
- インターフェイスの統一がされていること（HTTPメソッドの利用）
- ステートレスであること
    - **ステートレス**: クライアントのアプリケーション状態をサーバー側で管理しないこと
        - メリット: クライアント数が増加してもサーバーのコストは変わらない
        - デメリット: リクエストごとにすべての情報をサーバーへ送信するため、通信コストがかかる
    - REST的にはCookieを使ったセッション管理は悪
        - 毎回情報を送信しなければならないのはコストが高いため、実用上はセッション管理は有用である
- 処理結果がHTTPステータスコードで通知されること

***

## URI

- **URI(Uniform Resource Identifier)**
    - URL(Uniform Resource Locator) + URN(Uniform Resource Name) の総称
- **URL**
    - Web上で最もよく使われている識別子
    - ドメインによりリソースの場所を指定
- **URN**
    - ドメインを変更するとURLアドレスも変更されるなどの問題点を解決するために検討された使用
    - 例) 書籍のISBN： `urn:isbn:9784774142043`

### URIの基本構造
```
<URIスキーム>//[[ユーザー名]:[パスワード]@]<IPアドレス or ホスト名>[:[ポート番号]][/[パス]][?[クエリパラメータ]][#[URIフラグメント]]
```

(例) http://user:pass@example.jp:8000/search?q=test&debug=true#n10

### URIの設計指針
- プログラミング言語依存の拡張子を利用しない
    - 日本語や英語の指定をするなど、表現指定のための拡張子利用はあり
- 実装依存のパス名を利用しない（cgi-bin, servletなど）
- プログラミング言語のメソッド名を利用しない
- セッションIDを含めない
- リソースを表現する名詞で構成する

#### URI実装の注意点
- 相対URIと絶対URI
    - クライアント側で相対URIを解決するのは面倒なので、可能な限り絶対URIで記述する
- %エンコーディング
    - ASCII文字以外を含める場合はUTF-8で%エンコーディングするのが基本
- 長さ制限
    - InternetExpolorerの制限である2038バイト以内に収めるのが無難

***

## HTTP

- **HTTP(HypertText Trasfer Protocol)**
    - ハイパーテキスト転送プロトコルとして規定されたプロトコルだが、実際は画像や音楽などコンピュータで扱えるデータは全て転送可能

### TCP/IP
HTTPはTCP/IPをベースとする**階層型プロトコル**

#### 階層型プロトコル
- アプリケーション層: 階層の一番上。メールやDNS等のアプリケーションおよびHTTPを実現
    - **HTTP**, NTP, SSH, SMTP, DNS
- トランスポート層: IPが保証しなかったデータの転送を保証する部分
    - UDP
    - **TCP(Transmission Control Protocol)**
        - 接続先の相手に対してコネクションを張る
        - コネクションを使い、データの到達を保証
        - 接続先のどのアプリケーションにデータを渡すか決めるのが**ポート番号**
            - ポート番号は1～65535
            - HTTPはデフォルトで80番ポートを使用
- インターネット層: ネットワークで実際にデータをやりとりする部分
    - **IP(Internet Protocol)**
        - 指定したIPアドレスを送り先として、**パケット**単位（データの基本単位）でデータを送る
        - IPはデータを送ることだけを保証し、最終的な送り先まで届くかどうかは保証しない
- ネットワークインターフェイス層: 階層の一番下。物理的なケーブルやネットワークアダプタに相当
    - イーサネット

#### 階層型プロトコルの利点・欠点
- 利点
    - 構造が単純かつ柔軟
    - 各機能の隠蔽と独立したバージョンアップが可能
    - 異種ネットワークの相互接続が可能
- 欠点
    - 動作時の性能を高くすることができない
    - カプセル化処理によるメモリ管理・データ管理が困難

### HTTPメッセージ
- リクエストメッセージ
    ```bash
    # 基本構造
    <メソッド> <URI> <プロトコルバージョン> # リクエストライン
    <ヘッダ> # ヘッダ: メッセージのメタデータ。複数行指定可能
    (空行)
    [ボディ] # ボディ: メッセージの本質的な情報

    # 単純な例
    GET /test HTTP/1.1
    Host: example.jp:8000
        # => http://example.jp:8000/test にGETをリクエスト
    ```
- レスポンスメッセージ
    ```bash
    # 基本構造
    <プロトコルバージョン> <ステータスコード> <テキストフレーズ> # ステータスライン
    <ヘッダ>
    (空行)
    [ボディ]

    # 単純な例
    HTTP/1.1 200 OK # リクエストが正常に処理されたことを示す
    Content-Type: application/xhtml+xml; charset=utf-8 # レスポンスのメディアタイプと文字エンコーディングを指定
    (空行)
    <html xmls="http://www.w3.org/1999/xhtml">
    ...
    </html>
    ```

### HTTPメソッド

#### HTTP1.1で定義されているメソッド
メソッド|CRUDとの対応|意味
:--|:--|:--
POST|Create|子リソースの作成、データの追加等
GET|Read|リソースの取得
PUT|Update|リソースの更新
DELETE|Delete|リソースの削除
HEAD||リソースヘッダ（メタデータ）の取得
OPTIONS||リソースがサポートしているメソッドの取得
TRACE||プロキシ動作の確認
CONNECT||プロキシ動作のトンネル接続への変更

#### べき等性と安全性
- べき等性
  - ある操作を何回行っても結果が同じこと
- 安全性
  - 捜査対象のリソースの状態を変化させないこと（副作用がないこと）

メソッド|べき等性|安全性
:--|:--:|:--:
GET|○|○
PUT|○|×
DELETE|○|×
POST|×|×
