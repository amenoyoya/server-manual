# サーバ構築留意事項まとめ

## サーバセキュリティ
​
### サーバ構築時に対応する項目
- 外部公開する情報の制限
    - WEBサーバとDBサーバは極力分離し、DBサーバは内部ネットワーク内に配置する
    - 開発・テスト用サーバには Basic 認証、あるいは IP制限をかけ、外部公開を避ける
- SSH設定
    - SSHプロトコルは、脆弱性のあるバージョン1を禁止し、バージョン2の利用を強制する
    - SSHのデフォルト接続ポート25番は一般に知れ渡っており標的の対象となりやすいため、別のポートに変更する
    - root権限はサーバ内のあらゆる操作が可能であるため、root権限でのログインを不可とし、必要に応じた権限レベルのユーザを作成してログインする
    - パスワード認証は総当り攻撃の対象になるため禁止する（公開鍵認証のみ許可とする）
- ファイルアップロード等の制限
    - 基本的にファイルアップロード等は、FTP ではなく SFTP プロトコルを用いて行うこととする
    - SFTP プロトコルを用いてアクセスするユーザは、SSH アクセス可能なユーザとは別に作成し、システムコマンドの実行は不可能な権限レベルに設定する
    - SFTP 接続ユーザには chroot を設定し、DocumentRootより上位のディレクトリ階層にはアクセスできないように設定する
- 通信の暗号化
    - ネットワーク通信は、暗号化された通信プロトコルである https 通信ができるよう設定する
- パーミッションの設定
    - DocumentRoot の所有権は Apache 実行ユーザに設定し、Apache 実行ユーザ以外に書き換えすることはできないパーミッション（755 等）に設定する
    - 一時ディレクトリ等、やむを得ずパーミッション 777 を設定する場合は、所有者を root とした上でスティッキービットを設定する
- ファイアウォールの設定
    - 外部接続可能なポートを80番（httpポート）と443番（httpsポート）に制限する
    - SSH接続用ポートは可能なら IP 制限をかける
    - ポートスキャン攻撃に対する対策を行う
- ミドルウェアの自動復旧
    - sshd, httpd, mysqld などのミドルウェアの死活監視と自動復旧を設定する
    - monit を使っても良いが、KUSANAGI などと上手く共存できなかったりするので、crontab で自動復旧スクリプトを定期実行するのが簡単
- パスワードの設定・保管
    - SSH, SFTP 接続ユーザには基本的にパスワードを設定せず、公開鍵認証のみの設定とする
    - DBサーバ等のミドルウェアに設定するパスワードは推測されにくい十分な強度をもったものを設定する
    - DBサーバのパスワード等は、極力アプリケーションコードに直書きせず、環境変数等で保持することとする
    - 各パスワードは、作業担当者のみが把握している状態を担保する
    - 基本的にパスワードの定期的な変更は行わないが、先方のレギュレーションにより定期的な変更を要求された場合はその限りではない
        - 参考: NIST 電子的認証に関するガイドライン 2017/6 (NIST SP800-63-3)
- ドキュメントの作成
    - サーバ構成図（OS, スペック, ミドルウェア 等の情報も記載）
    - サーバ構築手順（コマンド等）の備忘録

### Apacheサーバ構築時に対応する項目
参考: https://www.ritolab.com/entry/45 等

- Apache, PHPバージョン情報の非表示化
    - `/etc/httpd/conf/httpd.conf`
        ```ruby
        # Apacheバージョン非表示
        ServerTokens ProductOnly
        ServerSignature off

        # PHPバージョン非表示
        ## PHP-FPM の場合は php.ini: expose_php を設定
        Header unset X-Powered-By
        ```
- デフォルトコンテンツ（Apacheのウェルカムページ）削除
    ```bash
    # welcome.conf を削除（リネーム）
    $ sudo mv /etc/httpd/conf.d/welcome.conf /etc/httpd/conf.d/welcome.conf.bak
    ```
- iconsディレクトリ削除
    - `https://<hostname>/icons/` でデフォルトコンテンツアイコンのディレクトリが確認できてしまうので無効化しておく
        ```bash
        # autoindex.conf を削除（リネーム）
        $ sudo mv /etc/httpd/conf.d/autoindex.conf /etc/httpd/conf.d/autoindex.conf.bak
        ```
- クリックジャッキング攻撃対策
    -  `/etc/httpd/conf/httpd.conf`
        ```ruby
        # X-Frame-Options HTTP レスポンスヘッダ送信
        Header append X-Ftame-Options "DENY"
        ```
    - ※ WordPress admin-ajax.php 利用系の管理画面を使う場合は、インラインフレームが表示できなくなるので注意
- クロスサイトトレーシング（XST）攻撃対策
    - `/etc/httpd/conf/httpd.conf`
        ```ruby
        # HTTP TRACE 機能を無効化
        TraceEnable off
        ```
- TLSv1.2 以上のプロトコル利用強制
    - TLSv1.0 には脆弱性があるため v1.2 以上を使う
    - `/etc/httpd/conf/httpd.conf`
        ```ruby
        # TLSv1.2 以上を使う
        SSLProtocol +TLSv1.2
        ```
- HTTP Strict Transport Security (HSTS) への対応
    - `/etc/httpd/conf/httpd.conf`
        ```ruby
        # Strict-Transport-Security のレスポンスヘッダを返す
        Header add Strict-Transport-Security "max-age=15768000"
        ```
- OCSP Stapling の有効化
    - `/etc/httpd/conf.d/*.conf`
        ```ruby
        # SSLStaplingCache 設定は <VirtualHost *:443> より前に記述
        SSLStaplingCache shmcb:/tmp/stapling_cache(128000)

        <VirtualHost *:80>
            # ...
        </VirtualHost>

        <VirtualHost *:443>
            # ...
            # SSLCACertificateFile /etc/ssl/ca-certs.pem などの下に以下を記述
            # SSLStapling 機能を有効化
            SSLUseStapling on
        </VirtualHost>
        ```
- .ht 系ファイル（`.htaccess` 等）を参照できないように設定
    ```ruby
    <Files ~ "^\.ht">
        Deny from all
    </Files>
    ```
- ディレクトリ一覧表示対策: `Options -Indexes`​

### 有料オプションとなるため、先方にヒアリングする項目
- IPS/IDS（ファイアウォールでは遮断できないプラットフォーム脆弱性への対策）の導入は必要か
    - よく使うのは Trend Micro 社の Deep Security
- WAF（ファイアウォール、IPS/IDS では遮断できないアプリケーション脆弱性への対策）の導入は必要か
    - よく使うのは AWS WAF + WafCharm （AWSでサーバ構築する場合）
- ログの長期保存やログレポートの提出は必要か
    - 過去のアクセスログ等を長期保存する場合は、AWS S3 等の保管サーバが必要
    - ログの解析レポート等が必要な場合は外部サービスの利用が必要
- Web改ざん検知は必要か
    - よく使うのは GRED, WegArgus 等（WebArgus は自動復旧機能あり）
- ウィルス対策（リアルタイム監視、定期スキャン）は必要か
    - よく使うのは Trend Micro 社の Deep Security
- 脆弱性のリスクレベルに応じたOSおよびミドルウェアのバージョンアップ対応は必要か
    - 脆弱性リスクの基準設定やパッチ適用期間の基準設定によっては運用・保守業者への委託が必要
- 24時間365日のサーバ監視・障害対応は必要か
    - 最低限のサーバ監視のみで良い場合は、Mackerel（フリープラン）や Zabbix 等で無料対応可
    - 有人サーバ監視や障害対応まで必要な場合は運用・保守業者への委託が必要
​
***
​
## アプリケーションセキュリティ
​
### 開発時対応する項目
- 開発PCのセキュリティ要件
    - 開発PCにはコンピュータ・ウイルス対策ソフトウェアを導入する
    - 開発PC、サーバーおよびそれらに接続する可搬記憶媒体の検査を常時実施する
    - 上記が不可能な場合は、他のセキュリティ施策を併用する等の設計を行う
- Git セキュリティ
    - 基本的に Git リポジトリはドキュメントルート配下に置かない
    - どうしてもドキュメントルート下に置く必要がある場合は `.git～` 系ファイルへのアクセス制限をかける
- 基本的なWEB脆弱性対策
    - SQLインジェクション、ディレクトリ・トラバーサル、クロスサイト・スクリプティング等の基本的な脆弱性対策を行う
    - 納品前に OWASP ZAP を用いたペネトレーションテストを行う
- 管理画面のセキュリティ設定
    - ユーザIDは利用者ごとに発行し、不要となったIDは速やかに削除できるようにする
    - ユーザID発行時の初期パスワードは、十分な強度を担保すること
    - パスワードの定期変更を要求することは基本的にしないが、先方のレギュレーションに従う
        - 参考: NIST 電子的認証に関するガイドライン 2017/6 (NIST SP800-63-3)
​
### 運用上の項目（作りきりの場合は不要）
- 運用管理のセキュリティ設定
    - 管理者IDを使用できる者は最小限にとどめ、6ヶ月に一度、使用できる者のリストを見直す
    - 管理者IDは、運用管理業務にのみ利用する（管理者IDで、インターネットの利用等、情報を盗聴される危険性の行為を行わない）
    - 運用管理業務を外部に委託している場合は、本要領に準拠し運用していることを確認する
​
### 先方にヒアリングする項目
- ソフトウェア脆弱性が見つかった場合のアラートおよびその対策は必要か
    - ソフトウェア脆弱性に関する対応をしてくれる運用・保守業者は基本的にいないため、必要があれば弊社で行う必要がある
    - ソフトウェアバージョンアップ等の対応は別途見積もりが必要である旨の協議をしておくこと
